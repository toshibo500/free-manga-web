# アーキテクチャ仕様書

## システム概要

FreeMangaDBは、無料で読めるマンガの情報を収集・提供するWebアプリケーションです。フロントエンドにNext.js、バックエンドにDjango REST APIを使用し、NGINXによるリバースプロキシでサービスを統合しています。

## 技術スタック

### フロントエンド

| 技術 | バージョン | 用途 |
|------|-----------|------|
| **Next.js** | 15.4.6 | Reactフレームワーク（App Router使用） |
| **React** | 19.1.0 | UIライブラリ |
| **TypeScript** | 5.9.2 | 型安全な開発 |
| **Tailwind CSS** | 3.3.1 | ユーティリティファーストCSSフレームワーク |

### 開発・ビルドツール

| 技術 | バージョン | 用途 |
|------|-----------|------|
| **Node.js** | 22.x | ランタイム環境 |
| **npm** | 最新 | パッケージマネージャー |
| **Docker** | 最新 | 開発環境コンテナ化 |
| **Docker Compose** | 最新 | マルチコンテナアプリケーション管理 |
| **ESLint** | 8.57.1 | コード品質管理・静的解析 |
| **Prettier** | 3.5.3 | コードフォーマッター |

### 型安全性・API統合

| 技術 | バージョン | 用途 |
|------|-----------|------|
| **openapi-typescript** | 7.8.0 | OpenAPIスキーマからの型生成 |
| **Swagger 2.0** | - | API仕様書（手動型定義） |
| **Axios** | 1.9.0 | HTTPクライアントライブラリ |
| **ts-node** | 10.9.2 | TypeScript実行環境 |

### 本番環境インフラ

| 技術 | バージョン | 用途 |
|------|-----------|------|
| **Ubuntu Server** | 最新LTS | サーバーOS |
| **Nginx** | 最新 | Webサーバー・リバースプロキシ・SSL終端 |
| **PM2** | 最新 | Node.jsプロセス管理・監視 |
| **Let's Encrypt** | - | SSL証明書（無料） |

### 外部サービス・API

| サービス | エンドポイント | 用途 |
|----------|---------------|------|
| **Django REST API** | backend.freemangadb.net | マンガデータ提供API |

## システム構成

### 開発環境

```
┌─────────────────┐
│   Developer     │
│   Local Machine │
└─────────────────┘
         │
         ▼
┌─────────────────┐
│   Docker        │
│   Environment   │
│                 │
│ ┌─────────────┐ │
│ │  Next.js    │ │ :3000
│ │  Frontend   │ │
│ └─────────────┘ │
└─────────────────┘
         │
         ▼ HTTP API calls
┌─────────────────┐
│   External      │
│   Django API    │ :8000
│   Server        │
└─────────────────┘
```

### 本番環境

```
┌─────────────────┐
│     Internet    │
│     Users       │
└─────────────────┘
         │ HTTPS
         ▼
┌─────────────────┐
│     Nginx       │
│  (SSL/Reverse   │ :443, :80
│     Proxy)      │
└─────────────────┘
         │
    ┌────┴────┐
    ▼         ▼
┌─────────┐ ┌─────────────┐
│ Next.js │ │   Django    │
│Frontend │ │  REST API   │ :8000
│   App   │ │   Server    │
│  (PM2)  │ │             │
└─────────┘ └─────────────┘
   :3000
```

## 開発環境詳細

### ローカル開発

- **Docker Compose**を使用してフロントエンド環境を構築
- **Hot Reload**により開発時の高速なフィードバックループを実現
- **TypeScript**によるコンパイル時型チェック

### 依存関係管理

- **package.json**でフロントエンドの依存関係を管理
- **npm scripts**でビルド、開発、テスト、型生成を自動化

## 本番環境詳細

### インフラ構成

1. **Ubuntu Server**
   - 安定性とセキュリティを重視したサーバーOS
   - 定期的なセキュリティアップデート対応

2. **Nginx**
   - SSL/TLS終端処理
   - 静的ファイル配信の最適化
   - リバースプロキシによるAPIとフロントエンドの統合
   - ロードバランシング（将来のスケーリング対応）

3. **PM2**
   - Node.jsプロセスの監視と自動再起動
   - クラスターモードによるマルチコア活用
   - ログ管理とメトリクス収集
   - ゼロダウンタイムデプロイメント

### セキュリティ

- **HTTPS強制**（HTTP→HTTPSリダイレクト）
- **Let's Encrypt**による自動SSL証明書更新
- **Security Headers**の設定
- **UFWファイアウォール**による不要ポートの遮断

## データフロー

### API通信

1. **ブラウザ** → **Nginx** → **Next.js App** → **Django API**
2. **レスポンス**: **Django API** → **Next.js App** → **Nginx** → **ブラウザ**

### 環境変数による設定

- **開発環境**: `.env.local`
- **本番環境**: `.env.production`
- **クライアントサイド**: `NEXT_PUBLIC_*` 環境変数
- **サーバーサイド**: `INTERNAL_*` 環境変数

## 型安全性の実現

### OpenAPI統合

1. **API仕様書**: `src/schema/manga-api.json` (Swagger 2.0形式)
2. **型生成**: `npm run generate-types`による自動型生成
3. **APIクライアント**: `src/api/mangaApi.ts`での型安全なHTTPリクエスト

### TypeScript設定

- **厳密な型チェック**による実行時エラーの事前防止
- **IDE補完**による開発効率向上
- **リファクタリング安全性**の確保

## パフォーマンス最適化

### フロントエンド

- **Next.js App Router**によるサーバーサイドレンダリング
- **静的生成**可能なページの事前生成
- **Tailwind CSS**による効率的なスタイリング
- **コード分割**による必要最小限のJavaScript配信

### インフラ

- **Nginx**による静的ファイルキャッシュ
- **PM2クラスター**によるマルチプロセス処理
- **Keep-Alive接続**による通信オーバーヘッド削減

## 運用・メンテナンス

### デプロイメント

1. **Git**によるソースコード管理
2. **npm run build**による本番ビルド
3. **PM2**による無停止アプリケーション更新
4. **Nginx**設定のリロード

### 監視・ログ

- **PM2 monit**によるリアルタイムモニタリング
- **Nginx access/error log**によるトラフィック分析
- **PM2 logs**によるアプリケーションログ確認

### バックアップ・復旧

- **設定ファイル**のバージョン管理
- **環境変数**のセキュアな管理
- **SSL証明書**の自動更新

## 将来の拡張性

### スケーラビリティ

- **Nginx Load Balancer**による水平スケーリング対応
- **PM2 Cluster Mode**による垂直スケーリング
- **CDN**統合による静的コンテンツ配信最適化

### 機能拡張

- **PWA**対応によるモバイルアプリ体験向上
- **検索機能**強化
- **ユーザー認証**システム統合
- **レコメンデーション**エンジン追加
